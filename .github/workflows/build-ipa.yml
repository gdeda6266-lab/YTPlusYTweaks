name: Build YTPlusTweaks IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install ldid dpkg unzip

    - name: Install Theos
      run: |
        git clone --recursive https://github.com/theos/theos.git ~/theos
        echo "THEOS=$HOME/theos" >> $GITHUB_ENV
        echo "$HOME/theos/bin" >> $GITHUB_PATH

    - name: Download YouTube IPA
      run: |
        mkdir ipa
        curl -L \
          -o ipa/app.ipa \
          https://github.com/gdeda6266-lab/YTPlusYTweaks/releases/download/release/app.ipa

    - name: Build tweak
      run: |
        make clean
        make package

    - name: Extract tweak dylib
      run: |
        dpkg-deb -x packages/*.deb extracted

    - name: Inject tweak into IPA
      run: |
        unzip ipa/app.ipa -d app
        cp extracted/Library/MobileSubstrate/DynamicLibraries/*.dylib app/Payload/YouTube.app/
        cp extracted/Library/MobileSubstrate/DynamicLibraries/*.plist app/Payload/YouTube.app/

    - name: Repack IPA
      run: |
        cd app
        zip -r YTPlusTweaks.ipa Payload

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: YTPlusTweaks-IPA
        path: app/YTPlusTweaks.ipa
